# version: "3.9"

# services:
#   # PostgreSQL database
#   db:
#     image: postgres:15
#     container_name: payment-db
#     restart: always
#     environment:
#       POSTGRES_USER: postgres
#       POSTGRES_PASSWORD: postgres
#       POSTGRES_DB: payments
#     ports:
#       - "5432:5432"
#     volumes:
#       - pgdata:/var/lib/postgresql/data
#       - ./backend/src/db/init.sql:/docker-entrypoint-initdb.d/init.sql 
#     healthcheck:
#       test: ["CMD-SHELL", "pg_isready -U postgres"]
#       interval: 10s
#       timeout: 5s
#       retries: 5

#   # Redis for job queue
#   redis:
#     image: redis:7-alpine
#     container_name: payment-redis
#     ports:
#       - "6379:6379"
#     healthcheck:
#       test: ["CMD", "redis-cli", "ping"]
#       interval: 10s
#       timeout: 3s
#       retries: 5

#   # Backend/API
#   backend:
#     build: ./backend
#     container_name: payment-backend
#     env_file:
#       - .env
#     ports:
#       - "8000:8000"  # backend accessible at localhost:8000
#     depends_on:
#       db:
#         condition: service_healthy
#       redis:
#         condition: service_healthy
#     healthcheck:
#       test: ["CMD", "curl", "-f", "http://localhost:3000/api/v1/health"]
#       interval: 10s
#       timeout: 5s
#       retries: 5


#   # Worker service for async jobs
#   worker:
#     build:
#       context: ./backend
#       dockerfile: Dockerfile.worker
#     container_name: payment-worker
#     env_file:
#       - .env
#     depends_on:
#       backend:
#         condition: service_healthy
#       redis:
#         condition: service_healthy
#       db:
#         condition: service_healthy

#   # Checkout frontend
#   checkout:
#     build: ./checkout
#     container_name: payment-checkout
#     ports:
#       - "3001:3000"  # checkout accessible at localhost:3001
#     depends_on:
#       backend:
#         condition: service_healthy

#   # Dashboard frontend
#   dashboard:
#     build: ./dashboard
#     container_name: payment-dashboard
#     ports:
#       - "3002:80"  # dashboard accessible at localhost:3002
#     depends_on:
#       backend:
#         condition: service_healthy

#   # Nginx reverse proxy
#   nginx:
#     image: nginx:latest
#     container_name: payment-nginx
#     ports:
#       - "80:80"  # accessible at localhost
#     volumes:
#       - ./nginx/nginx.conf:/etc/nginx/nginx.conf
#     depends_on:
#       backend:
#         condition: service_healthy
#       # checkout:
#       #   condition: service_healthy
#       # dashboard:
#       #   condition: service_healthy

# volumes:
#   pgdata:

version: '3.9'

services:
  # PostgreSQL database
  db:
    image: postgres:15-alpine
    container_name: payment-db
    restart: always
    environment:
      POSTGRES_USER: gateway_user
      POSTGRES_PASSWORD: gateway_pass
      POSTGRES_DB: payment_gateway
    ports:
      - "5432:5432"
    volumes:
      - pgdata:/var/lib/postgresql/data
      - ./backend/database/init.sql:/docker-entrypoint-initdb.d/init.sql
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U gateway_user -d payment_gateway"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Redis for job queue
  redis:
    image: redis:7-alpine
    container_name: payment-redis
    ports:
      - "6379:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5

  # Backend/API
  backend:
    build: ./backend
    container_name: payment-backend
    env_file:
      - .env
    ports:
      - "8000:8000"  # backend accessible at localhost:8000
    environment:
      DATABASE_URL: postgresql://gateway_user:gateway_pass@db:5432/payment_gateway
      REDIS_URL: redis://redis:6379
      PORT: 8000
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/api/v1/health"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Worker service for async jobs
  worker:
    build:
      context: ./backend
      dockerfile: Dockerfile.worker
    container_name: payment-worker
    env_file:
      - .env
    depends_on:
      backend:
        condition: service_healthy
      redis:
        condition: service_healthy
      db:
        condition: service_healthy

  # Checkout frontend (from friend's repo)
  checkout:
    build:
      context: ./checkout-page  # make sure this path points to friend's checkout
    container_name: payment-checkout
    ports:
      - "3001:80"  # checkout accessible at localhost:3001
    environment:
      REACT_APP_API_BASE_URL: http://localhost:8000/api/v1
    depends_on:
      backend:
        condition: service_healthy

  # Dashboard frontend (from friend's repo)
  dashboard:
    build:
      context: ./frontend  # make sure this path points to friend's dashboard
    container_name: payment-dashboard
    ports:
      - "3002:80"  # dashboard accessible at localhost:3002
    environment:
      REACT_APP_API_BASE_URL: http://localhost:8000/api/v1
    depends_on:
      backend:
        condition: service_healthy

volumes:
  pgdata:

